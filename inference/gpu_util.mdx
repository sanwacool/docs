---
title: "GPU åˆ©ç”¨ç‡æ²»ç†"
---

### åè¯è§£é‡Š

#### `HTTP â†’ tokenization â†’ routing â†’ batching â†’ GPU enqueue â†’ kernel` æ˜¯å•¥ï¼Ÿ

##### â‘  HTTP

- ç”¨æˆ·è¯·æ±‚åˆ°è¾¾æœåŠ¡ï¼ˆFastAPI / Triton / è‡ªç ”ç½‘å…³ï¼‰
- è¿˜åªæ˜¯å­—ç¬¦ä¸²

##### â‘¡ tokenization

- `"ä½ æ˜¯è°"` â†’ `[101, 2034, 3221, 102]`
- BPE / SentencePiece

##### â‘¢ routing

- è¿™ä¸ªè¯·æ±‚è¯¥å»å“ªå¼ å¡ï¼Ÿ
- å“ªä¸ªæ¨¡å‹å®ä¾‹ï¼Ÿ
- å“ªä¸ª workerï¼Ÿ

##### â‘£ batching

- æŠŠå¤šä¸ªè¯·æ±‚æ‹¼æˆä¸€ä¸ª batch
- å†³å®šï¼š
  - batch size
  - padding
  - attention mask

##### â‘¤ GPU enqueue

- æŠŠ tensor æ‹·åˆ° GPU
- è°ƒç”¨ cudaLaunchKernel

##### â‘¥ kernel

- GEMM / attention / softmax çœŸæ­£è·‘èµ·æ¥

#### batch_size

- batch_size  = ä¸€æ¬¡ GPU kernel é‡ŒåŒæ—¶ç®—å¤šå°‘ä¸ªè¯·æ±‚/token

#### samplingï¼ˆtop-k / top-pï¼‰æ˜¯ CPU-heavy

sampling åšçš„äº‹æ˜¯ï¼š

1. æ‹¿ logitsï¼ˆå‡ ä¸‡ç»´ï¼‰
2. æ’åº / å– top-k
3. ç´¯åŠ æ¦‚ç‡
4. éšæœºé‡‡æ ·

å¾ˆå¤šç³»ç»Ÿï¼š

- logits ä» GPU æ‹·å› CPU
- åœ¨ CPU åšæ’åº

ğŸ‘‰ æ¯ä¸ª token éƒ½åšä¸€æ¬¡

#### warp

- warp æ˜¯ ä»€ä¹ˆï¼š GPU æœ€å°æ‰§è¡Œå•ä½ = 32 ä¸ªçº¿ç¨‹
- warp å°‘æ„å‘³ç€ï¼šåŒæ—¶åœ¨è·‘çš„çº¿ç¨‹ç»„å°‘ï¼›SM é‡Œé¢å¾ˆå¤šæ‰§è¡Œå•å…ƒç©ºç€

#### occupancy

- occupancy = SM ä¸Šâ€œæ´»è·ƒ warp æ•° / æœ€å¤§å¯æ”¯æŒ warp æ•°â€

#### kernel

- kernel = GPU ä¸Šè·‘çš„ä¸€æ®µå‡½æ•°ï¼›æ¯”å¦‚ä¸€æ¬¡ GEMMï¼Œä¸€æ¬¡ attentionï¼Œä¸€æ¬¡ softmax

#### cuda kernel launch

- cpu å¯¹ gpu è¯´ï¼šâ€œè¯·ä½ æ‰§è¡Œè¿™æ®µ kernelâ€
- gpu ä¸èƒ½è‡ªå·±å†³å®šå¹²ä»€ä¹ˆï¼Œæ¯ä¸€ä¸ª kernelï¼Œéƒ½æ˜¯ cpu å¯åŠ¨çš„
- ä¸€æ¬¡ kernel launch åŒ…å«ï¼š å‚æ•°æ‰“åŒ…ï¼Œkernel é…ç½®ï¼Œå‘½ä»¤å†™å…¥ GPU command queueï¼Œgpu è§£æå‘½ä»¤

#### prefillå’Œdecode çš„kernel launch

prefill

1. QKV projection
   1. kernelï¼šå¤§ gemmï¼› ç‰¹ç‚¹ï¼šbatch x seq_len å¾ˆå¤§ï¼Œtensor core æ»¡è½½ï¼›nsight æ˜¯åˆå®½åˆé•¿çš„çŸ©å½¢
2. Attention
   1. kernel ç»„åˆï¼šQKáµ€ GEMMã€softmaxã€attention x V GEMM
3. MLP
   1. kernelï¼š2 ä¸ªå¤§ GEMM
4. LayerNorm
5. æ€»ç»“ï¼šprefill çš„ kernel æ•°å°‘ï¼Œkernel æ—¶é•¿ï¼šé•¿ï¼ŒGPU åˆ©ç”¨ç‡é«˜

decode

1. embedding
2. æ¯ä¸€å±‚transformer
   1. QKV Projection  å° GEMMï¼›tensor core åˆ©ç”¨ç‡ä½ï¼›launch å¾ˆå¤š
   2. Attentionï¼š  memory-bound
   3. MLP   launch æ¬¡æ•°å¤šï¼Œç®—æ³•åƒä¸æ»¡
   4. layerNorm
3. sampling

   é€šå¸¸åœ¨ CPU

æ€»ç»“

- decode é˜¶æ®µ kernel æ•°éå¸¸å¤šï¼›æ‰€ä»¥ä¸€èˆ¬æŠŠ decode é˜¶æ®µçš„ batch_size è®¾ç½®å¾ˆå¤§ï¼Œæ¯”å¦‚ 400ï¼›